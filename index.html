<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Painel Micron — Supervisor</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{--bg:#121212;--panel:#1e1e1e;--muted:#2c2c2c;--text:#f5f5f5;--brand:#ff6600;--ok:#27ae60;--bad:#e74c3c;--pend:#f1c40f;--border:#333}
    *{box-sizing:border-box}
    body{font-family:Arial,Helvetica,sans-serif;margin:18px;background:var(--bg);color:var(--text)}
    h1,h2{margin:6px 0;color:var(--brand);text-align:center}
    .card{background:var(--panel);padding:12px;border-radius:10px;margin:10px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,select,button,textarea{padding:8px;border-radius:6px;border:none;background:var(--muted);color:#fff}
    button{cursor:pointer;background:var(--brand);color:#fff}
    .hidden{display:none}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px;border:1px solid var(--border);text-align:left}
    th{background:var(--brand);color:#fff}
    .badge{padding:4px 8px;border-radius:999px;font-weight:bold}
    .pendente{background:var(--pend);color:#000}
    .instalado{background:var(--ok);color:#fff}
    .cancelado{background:var(--bad);color:#fff}
    .actions button{margin-right:6px;padding:6px}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .link{color:#fff;text-decoration:underline}
    .small{font-size:13px;opacity:.9}
    .flex-between{display:flex;justify-content:space-between;align-items:center}
    .charts{display:flex;flex-wrap:wrap;gap:12px}
    canvas{background:var(--panel);padding:8px;border-radius:8px;max-width:320px}
    .note{font-size:13px;opacity:.85}
  </style>
</head>
<body>
  <h1>Painel Micron</h1>

  <div id="loginCard" class="card">
    <div class="row">
      <input id="username" placeholder="Usuario (ex: colaborador1)" autocomplete="username" />
      <input id="password" type="password" placeholder="Senha" autocomplete="current-password" />
      <button id="btnLogin">Entrar</button>
      <span class="small note">Supervisor: usuario <b>supervisor</b></span>
    </div>
  </div>

  <div id="app" class="hidden">
    <div class="topbar card">
      <div>
        <strong id="welcome"></strong>
        <div class="small" id="roleLabel"></div>
      </div>
      <div class="row">
        <button id="btnLogout">Sair</button>
      </div>
    </div>

    <!-- area de cadastro de vendas (visivel para colaboradores e supervisor) -->
    <div id="formCard" class="card">
      <h2>Cadastro de Venda</h2>
      <div class="row">
        <input type="text" id="protocolo" placeholder="Protocolo" />
        <input type="text" id="cliente" placeholder="Cliente" />
        <select id="localidade">
          <option value="">Localidade</option>
          <option value="Urbana">Urbana</option>
          <option value="Rural">Rural</option>
        </select>
        <span id="planoWrap" class="hidden">
          <select id="plano"><option value="">Selecione o plano</option></select>
        </span>
        <span id="taxaWrap" class="hidden">
          <select id="taxa"><option value="">Selecione a taxa</option><option value="150">R$ 150,00</option><option value="300">R$ 300,00</option><option value="600">R$ 600,00</option></select>
        </span>
        <span id="diasWrap" class="hidden"><input id="dias" placeholder="Dias proporcionais (ex: R$ 75,00)" /></span>
        <button id="btnAdd">Adicionar</button>
      </div>
    </div>

    <!-- supervisor panel -->
    <div id="supervisorPanel" class="card hidden">
      <h2>Painel Supervisor</h2>
      <div class="row">
        <select id="filterUser"><option value="all">Todos os colaboradores</option></select>
        <select id="filterSituacao"><option value="all">Todas as situacoes</option><option value="Instalado">Instalado</option><option value="Pendente">Pendente</option><option value="Cancelado">Cancelado</option></select>
        <button id="btnExportAll">Exportar CSV (Todos)</button>
        <button id="btnExportByUser">Exportar CSV (Selecionado)</button>
      </div>
      <div style="margin-top:10px" class="row">
        <div style="min-width:260px">
          <div class="small">Criar usuario (apenas supervisor)</div>
          <input id="newUser" placeholder="novo usuario" />
          <input id="newPass" placeholder="nova senha" />
          <select id="newRole"><option value="colaborador">colaborador</option><option value="supervisor">supervisor</option></select>
          <button id="btnCreateUser">Criar usuario</button>
        </div>
      </div>
      <div class="note">Supervisor ve todas as vendas, pode exportar e criar usuarios.</div>
    </div>

    <!-- tabela de vendas -->
    <div class="card">
      <h2>Vendas</h2>
      <div class="flex-between">
        <div class="small">Registros armazenados localmente (localStorage). Supervisor ve tudo.</div>
        <div class="small">Total: <span id="totalCount">0</span></div>
      </div>
      <table id="tableVendas"><thead><tr><th>Protocolo</th><th>Cliente</th><th>Plano</th><th>Localidade</th><th>Taxa</th><th>Dias</th><th>Situacao</th><th>Usuario</th><th>Acoes</th></tr></thead><tbody></tbody></table>
    </div>

    <div class="card">
      <h2>Graficos & Resumo</h2>
      <div class="charts">
        <canvas id="chartVendas"></canvas>
        <canvas id="chartTaxa"></canvas>
        <canvas id="chartDias"></canvas>
        <canvas id="chartResumo"></canvas>
      </div>
      <div id="resumoBoxes" class="row" style="margin-top:10px"></div>
    </div>
  </div>

<script>
// -----------------------------
// CONFIGURACAO DE SUPERVISOR (base64)
// -----------------------------
const SUPERVISOR_USER = 'supervisor';
const SUPERVISOR_PASS_B64 = 'TWljcm9uQDIwMjU='; // base64 da senha: Micron@2025

// -----------------------------
// Utilitarios
// -----------------------------
const $ = s => document.querySelector(s);
const ls = window.localStorage;
function encodeBase64(str){ try{return btoa(str);}catch(e){return '';} }
function decodeBase64(b64){ try{return atob(b64);}catch(e){return '';} }

// normalizar texto: remover acentos e caracteres estranhos
function normalizeText(str){ if(!str) return ''; return str.normalize('NFD').replace(/[̀-ͯ]/g, '').replace(/[^
